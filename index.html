<!DOCTYPE html><html lang="en"><head><meta name="x-poe-datastore-behavior" content="local_only"><meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob: https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://code.jquery.com https://unpkg.com https://d3js.org https://threejs.org https://cdn.plot.ly https://stackpath.bootstrapcdn.com https://maps.googleapis.com https://cdn.tailwindcss.com https://ajax.googleapis.com https://kit.fontawesome.com https://cdn.datatables.net https://maxcdn.bootstrapcdn.com https://code.highcharts.com https://tako-static-assets-production.s3.amazonaws.com https://www.youtube.com https://fonts.googleapis.com https://fonts.gstatic.com https://pfst.cf2.poecdn.net https://puc.poecdn.net https://i.imgur.com https://wikimedia.org https://*.icons8.com https://*.giphy.com https://picsum.photos https://images.unsplash.com; frame-src 'self' https://www.youtube.com https://trytako.com; child-src 'self'; manifest-src 'self'; worker-src 'self'; upgrade-insecure-requests; block-all-mixed-content;">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DataForge Pro " Transform Your Data</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&amp;family=Inter:wght@300;400;500;600;700&amp;display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        forge: {
                            50: '#fef7ec', 100: '#fcecc8', 200: '#f9d88c', 300: '#f5be4f',
                            400: '#f2a628', 500: '#eb8a0f', 600: '#cf6509', 700: '#ac460b',
                            800: '#8c3710', 900: '#732e10',
                        },
                        night: { 800: '#1a1a2e', 900: '#0f0f1a', 950: '#080810' }
                    }
                }
            }
        }
    </script>
    <style>
        :root { --gradient-start: #f5be4f; --gradient-end: #eb8a0f; }
        .dark { --gradient-start: #f2a628; --gradient-end: #cf6509; }
        body { background: linear-gradient(135deg, #fef7ec 0%, #fcecc8 50%, #fff 100%); }
        .dark body { background: linear-gradient(135deg, #0f0f1a 0%, #1a1a2e 50%, #080810 100%); }
        .glass-card { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.3); }
        .dark .glass-card { background: rgba(26, 26, 46, 0.8); border: 1px solid rgba(255, 255, 255, 0.1); }
        .btn-forge { background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end)); transition: all 0.3s ease; }
        .btn-forge:hover { transform: translateY(-2px); box-shadow: 0 10px 30px -10px rgba(235, 138, 15, 0.5); }
        .table-container { max-height: 45vh; overflow: auto; }
        .table-container::-webkit-scrollbar { width: 8px; height: 8px; }
        .table-container::-webkit-scrollbar-track { background: rgba(0,0,0,0.05); border-radius: 4px; }
        .table-container::-webkit-scrollbar-thumb { background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end)); border-radius: 4px; }
        .data-table th { position: sticky; top: 0; z-index: 10; cursor: pointer; user-select: none; }
        .data-table th:hover { background: linear-gradient(135deg, #cf6509, #ac460b); }
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .toast { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .cell-input { background: transparent; border: 2px solid #f2a628; border-radius: 4px; padding: 2px 6px; width: 100%; min-width: 80px; outline: none; }
        .drop-zone { border: 2px dashed #d1d5db; transition: all 0.3s ease; }
        .dark .drop-zone { border-color: #374151; }
        .drop-zone.dragover { border-color: #f2a628; background: rgba(242, 166, 40, 0.1); }
        .dropdown-menu { display: none; position: absolute; left: 0; z-index: 50; min-width: 200px; }
        .dropdown-menu.active { display: block; }
        .dropdown-menu.dropdown-down { top: 100%; bottom: auto; }
        .dropdown-menu.dropdown-up { bottom: 100%; top: auto; margin-bottom: 0.5rem; }
        .dropdown-menu.dropdown-fixed { position: fixed; }
        .selected-row { background: rgba(139, 92, 246, 0.2) !important; }
        .frozen-col { position: sticky; left: 0; z-index: 5; background: inherit; }
        .duplicate-row { background: rgba(239, 68, 68, 0.15) !important; }
        .dragging { opacity: 0.5; }
        .drag-over { border-left: 3px solid #f2a628 !important; }
        .modal-overlay { background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); }
        .chart-container { height: 300px; }
        .toolbar-btn { padding: 0.5rem 0.75rem; border-radius: 0.5rem; font-size: 0.875rem; font-weight: 500; transition: all 0.2s; display: flex; align-items: center; gap: 0.5rem; }
        .toolbar-btn:hover { background: rgba(0,0,0,0.05); }
        .dark .toolbar-btn:hover { background: rgba(255,255,255,0.1); }
        .type-badge { padding: 0.125rem 0.5rem; border-radius: 0.25rem; font-size: 0.625rem; font-family: monospace; }
        .type-number { background: rgba(59, 130, 246, 0.15); color: #3b82f6; }
        .type-string { background: rgba(34, 197, 94, 0.15); color: #22c55e; }
        .type-date { background: rgba(168, 85, 247, 0.15); color: #a855f7; }
        .type-boolean { background: rgba(249, 115, 22, 0.15); color: #f97316; }
        .type-empty { background: rgba(107, 114, 128, 0.15); color: #6b7280; }
    </style>
</head>
<body class="min-h-screen font-sans text-gray-800 dark:text-gray-100">
    <div id="toastContainer" class="fixed top-4 right-4 z-[100] flex flex-col gap-2"></div>

    <!-- Header -->
    <header class="py-4 px-4 border-b border-gray-200 dark:border-gray-700 bg-white/50 dark:bg-night-900/50 backdrop-blur-lg sticky top-0 z-40">
        <div class="max-w-7xl mx-auto flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-forge-400 to-forge-600 flex items-center justify-center shadow-lg">
                    <i class="fas fa-fire text-white text-lg"></i>
                </div>
                <h1 class="text-xl font-bold bg-gradient-to-r from-forge-600 to-forge-500 bg-clip-text text-transparent">DataForge Pro</h1>
            </div>
            <div class="flex items-center gap-3">
                <button id="themeToggle" class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-all" title="Toggle theme">
                    <i class="fas fa-sun dark:hidden text-gray-600"></i>
                    <i class="fas fa-moon hidden dark:block text-gray-300"></i>
                </button>
                <div class="flex items-center gap-2 text-sm text-gray-500 dark:text-gray-400">
                    <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                    <span class="font-mono text-xs">Ready</span>
                </div>
            </div>
        </div>
    </header>

    <main class="px-4 py-6">
        <div class="max-w-7xl mx-auto">
            <!-- Input Section -->
            <section id="inputSection" class="fade-in">
                <div class="glass-card rounded-2xl p-6 shadow-xl">
                    <div class="flex flex-col sm:flex-row gap-3 mb-6">
                        <button id="tabPaste" class="tab-btn flex-1 py-3 px-6 rounded-xl font-semibold bg-forge-500 text-white shadow-lg">
                            <i class="fas fa-paste mr-2"></i>Paste Data
                        </button>
                        <button id="tabUpload" class="tab-btn flex-1 py-3 px-6 rounded-xl font-semibold bg-gray-200 dark:bg-gray-700 text-gray-600 dark:text-gray-300">
                            <i class="fas fa-upload mr-2"></i>Upload File
                        </button>
                        <button id="tabUrl" class="tab-btn flex-1 py-3 px-6 rounded-xl font-semibold bg-gray-200 dark:bg-gray-700 text-gray-600 dark:text-gray-300">
                            <i class="fas fa-link mr-2"></i>From URL
                        </button>
                    </div>

                    <div id="pastePanel">
                        <textarea id="dataInput" class="w-full h-48 p-4 rounded-xl bg-white dark:bg-night-800 border border-gray-200 dark:border-gray-700 font-mono text-sm resize-none focus:outline-none focus:ring-2 focus:ring-forge-400" placeholder="Paste CSV, JSON, or TSV data here..."></textarea>
                        <div class="mt-4 flex flex-wrap gap-3">
                            <button id="parseBtn" class="btn-forge py-3 px-8 rounded-xl font-semibold text-white shadow-lg">
                                <i class="fas fa-wand-magic-sparkles mr-2"></i>Parse Data
                            </button>
                            <button id="clearInputBtn" class="py-3 px-6 rounded-xl font-semibold bg-gray-200 dark:bg-gray-700 text-gray-600 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-gray-600">
                                <i class="fas fa-eraser mr-2"></i>Clear
                            </button>
                        </div>
                    </div>

                    <div id="uploadPanel" class="hidden">
                        <div id="dropZone" class="drop-zone rounded-xl p-12 text-center cursor-pointer">
                            <i class="fas fa-cloud-arrow-up text-5xl text-forge-400 mb-4"></i>
                            <p class="text-lg font-semibold mb-2">Drop your file here</p>
                            <p class="text-gray-500 text-sm mb-4">CSV, JSON, TSV, TXT, XLSX</p>
                            <input type="file" id="fileInput" class="hidden" accept=".csv,.json,.tsv,.txt,.xlsx,.xls">
                        </div>
                        <div id="fileInfo" class="hidden mt-4 p-4 rounded-xl bg-forge-50 dark:bg-forge-900/20 border border-forge-200 dark:border-forge-800">
                            <div class="flex items-center gap-3">
                                <i class="fas fa-file-lines text-forge-500 text-xl"></i>
                                <div class="flex-1"><p id="fileName" class="font-semibold truncate"></p><p id="fileSize" class="text-sm text-gray-500"></p></div>
                                <button id="removeFileBtn" class="p-2 text-gray-400 hover:text-red-500"><i class="fas fa-xmark"></i></button>
                            </div>
                        </div>
                    </div>

                    <div id="urlPanel" class="hidden">
                        <div class="flex gap-3">
                            <input type="url" id="urlInput" class="flex-1 py-3 px-4 rounded-xl bg-white dark:bg-night-800 border border-gray-200 dark:border-gray-700 focus:outline-none focus:ring-2 focus:ring-forge-400 text-base" placeholder="https://example.com/data.csv">
                            <button id="loadUrlBtn" class="btn-forge py-3 px-6 rounded-xl font-semibold text-white">
                                <i class="fas fa-download mr-2"></i>Load
                            </button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Output Section -->
            <section id="outputSection" class="hidden fade-in">
                <div class="glass-card rounded-2xl shadow-xl overflow-hidden">
                    <!-- Toolbar -->
                    <div id="toolbar" class="p-3 border-b border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-night-900/50">
                        <div class="flex flex-wrap items-center gap-2">
                            <!-- Data Actions Dropdown -->
                            <div class="relative">
                                <button id="dataActionsBtn" class="toolbar-btn bg-white dark:bg-night-800 border border-gray-200 dark:border-gray-700">
                                    <i class="fas fa-database"></i><span class="hidden sm:inline">Data</span><i class="fas fa-chevron-down text-xs ml-1"></i>
                                </button>
                                <div id="dataActionsMenu" class="dropdown-menu dropdown-down bg-white dark:bg-night-800 rounded-lg shadow-xl border border-gray-200 dark:border-gray-700 py-1">
                                    <button class="w-full px-4 py-2 text-left text-sm hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center gap-2" onclick="addRow()"><i class="fas fa-plus w-4"></i>Add Row</button>
                                    <button class="w-full px-4 py-2 text-left text-sm hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center gap-2" onclick="deleteSelectedRows()"><i class="fas fa-trash w-4"></i>Delete Selected</button>
                                    <hr class="my-1 border-gray-200 dark:border-gray-700">
                                    <button class="w-full px-4 py-2 text-left text-sm hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center gap-2" onclick="showAddColumnModal()"><i class="fas fa-columns w-4"></i>Add Column</button>
                                    <button class="w-full px-4 py-2 text-left text-sm hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center gap-2" onclick="showFormulaModal()"><i class="fas fa-calculator w-4"></i>Formula Column</button>
                                    <hr class="my-1 border-gray-200 dark:border-gray-700">
                                    <button class="w-full px-4 py-2 text-left text-sm hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center gap-2" onclick="findDuplicates()"><i class="fas fa-copy w-4"></i>Find Duplicates</button>
                                    <button class="w-full px-4 py-2 text-left text-sm hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center gap-2" onclick="cleanData()"><i class="fas fa-broom w-4"></i>Clean Data</button>
                                    <button class="w-full px-4 py-2 text-left text-sm hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center gap-2" onclick="mergeFile()"><i class="fas fa-code-merge w-4"></i>Merge File</button>
                                </div>
                            </div>

                            <!-- Column Actions Dropdown -->
                            <div class="relative">
                                <button id="columnActionsBtn" class="toolbar-btn bg-white dark:bg-night-800 border border-gray-200 dark:border-gray-700">
                                    <i class="fas fa-table-columns"></i><span class="hidden sm:inline">Columns</span><i class="fas fa-chevron-down text-xs ml-1"></i>
                                </button>
                                <div id="columnActionsMenu" class="dropdown-menu dropdown-down bg-white dark:bg-night-800 rounded-lg shadow-xl border border-gray-200 dark:border-gray-700 py-1 max-h-64 overflow-auto" style="min-width: 220px;"></div>
                            </div>

                            <!-- View Options -->
                            <div class="relative">
                                <button id="viewOptionsBtn" class="toolbar-btn bg-white dark:bg-night-800 border border-gray-200 dark:border-gray-700">
                                    <i class="fas fa-eye"></i><span class="hidden sm:inline">View</span><i class="fas fa-chevron-down text-xs ml-1"></i>
                                </button>
                                <div id="viewOptionsMenu" class="dropdown-menu dropdown-down bg-white dark:bg-night-800 rounded-lg shadow-xl border border-gray-200 dark:border-gray-700 py-1">
                                    <button class="w-full px-4 py-2 text-left text-sm hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center gap-2" onclick="toggleRowNumbers()"><i class="fas fa-list-ol w-4"></i><span id="rowNumLabel">Show Row Numbers</span></button>
                                    <button class="w-full px-4 py-2 text-left text-sm hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center gap-2" onclick="toggleFreezeFirstCol()"><i class="fas fa-thumbtack w-4"></i><span id="freezeLabel">Freeze First Column</span></button>
                                    <button class="w-full px-4 py-2 text-left text-sm hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center gap-2" onclick="toggleFullscreen()"><i class="fas fa-expand w-4"></i>Fullscreen</button>
                                    <hr class="my-1 border-gray-200 dark:border-gray-700">
                                    <button class="w-full px-4 py-2 text-left text-sm hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center gap-2" onclick="showStatsPanel()"><i class="fas fa-chart-bar w-4"></i>Statistics</button>
                                    <button class="w-full px-4 py-2 text-left text-sm hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center gap-2" onclick="showChartModal()"><i class="fas fa-chart-pie w-4"></i>Quick Chart</button>
                                </div>
                            </div>

                            <!-- Find & Replace -->
                            <button id="findReplaceBtn" class="toolbar-btn bg-white dark:bg-night-800 border border-gray-200 dark:border-gray-700" onclick="toggleFindReplace()">
                                <i class="fas fa-search-plus"></i><span class="hidden sm:inline">Find/Replace</span>
                            </button>

                            <button id="backBtn" class="ml-auto toolbar-btn bg-gray-200 dark:bg-gray-700 text-gray-600 dark:text-gray-300">
                                <i class="fas fa-arrow-left"></i><span class="hidden sm:inline">New Data</span>
                            </button>
                        </div>
                    </div>

                    <!-- Find & Replace Panel -->
                    <div id="findReplacePanel" class="hidden p-3 border-b border-gray-200 dark:border-gray-700 bg-yellow-50 dark:bg-yellow-900/20">
                        <div class="flex flex-wrap items-center gap-3">
                            <div class="flex-1 min-w-[200px]">
                                <input type="text" id="findInput" class="w-full py-2 px-3 rounded-lg bg-white dark:bg-night-800 border border-gray-300 dark:border-gray-600 text-sm" placeholder="Find...">
                            </div>
                            <div class="flex-1 min-w-[200px]">
                                <input type="text" id="replaceInput" class="w-full py-2 px-3 rounded-lg bg-white dark:bg-night-800 border border-gray-300 dark:border-gray-600 text-sm" placeholder="Replace with...">
                            </div>
                            <button onclick="findNext()" class="px-4 py-2 rounded-lg bg-blue-500 text-white text-sm font-medium hover:bg-blue-600">Find</button>
                            <button onclick="replaceOne()" class="px-4 py-2 rounded-lg bg-forge-500 text-white text-sm font-medium hover:bg-forge-600">Replace</button>
                            <button onclick="replaceAll()" class="px-4 py-2 rounded-lg bg-forge-600 text-white text-sm font-medium hover:bg-forge-700">Replace All</button>
                            <span id="findCount" class="text-sm text-gray-600 dark:text-gray-400"></span>
                        </div>
                    </div>

                    <!-- Stats Bar -->
                    <div class="p-3 border-b border-gray-200 dark:border-gray-700 flex flex-wrap items-center gap-3">
                        <div class="flex items-center gap-2 px-3 py-1.5 rounded-lg bg-forge-100 dark:bg-forge-900/30">
                            <i class="fas fa-table-cells text-forge-600 text-sm"></i>
                            <span class="font-mono text-sm"><span id="rowCount">0</span> rows</span>
                        </div>
                        <div class="flex items-center gap-2 px-3 py-1.5 rounded-lg bg-forge-100 dark:bg-forge-900/30">
                            <i class="fas fa-columns text-forge-600 text-sm"></i>
                            <span class="font-mono text-sm"><span id="colCount">0</span> cols</span>
                        </div>
                        <div id="selectedInfo" class="hidden items-center gap-2 px-3 py-1.5 rounded-lg bg-violet-100 dark:bg-violet-900/30">
                            <i class="fas fa-check-square text-violet-600 text-sm"></i>
                            <span class="font-mono text-sm"><span id="selectedCount">0</span> selected</span>
                        </div>

                        <!-- Search -->
                        <div class="flex-1 min-w-[200px] ml-auto">
                            <div class="relative">
                                <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-sm"></i>
                                <input type="text" id="searchInput" class="w-full py-2 pl-9 pr-3 rounded-lg bg-white dark:bg-night-800 border border-gray-200 dark:border-gray-700 text-sm" placeholder="Search...">
                            </div>
                        </div>
                    </div>

                    <!-- Table -->
                    <div id="tableWrapper" class="table-container">
                        <table id="dataTable" class="data-table w-full text-sm">
                            <thead id="tableHead" class="bg-gradient-to-r from-forge-500 to-forge-600 text-white"></thead>
                            <tbody id="tableBody" class="bg-white dark:bg-night-800"></tbody>
                        </table>
                    </div>

                    <!-- Pagination & Export -->
                    <div class="p-3 border-t border-gray-200 dark:border-gray-700 flex items-center gap-3 overflow-x-auto">
                        <div class="flex items-center gap-2 flex-shrink-0">
                            <select id="pageSizeSelect" class="py-2 px-3 rounded-lg bg-white dark:bg-night-800 border border-gray-200 dark:border-gray-700 text-sm">
                                <option value="25">25</option>
                                <option value="50">50</option>
                                <option value="100">100</option>
                                <option value="all">All</option>
                            </select>
                            <span id="pageInfo" class="text-sm text-gray-600 dark:text-gray-400 whitespace-nowrap"></span>
                        </div>
                        <div class="flex items-center gap-1 flex-shrink-0 mx-auto">
                            <button id="prevPage" class="p-2 rounded-lg bg-gray-100 dark:bg-gray-700 disabled:opacity-40"><i class="fas fa-chevron-left"></i></button>
                            <div id="pageNumbers" class="flex items-center gap-1"></div>
                            <button id="nextPage" class="p-2 rounded-lg bg-gray-100 dark:bg-gray-700 disabled:opacity-40"><i class="fas fa-chevron-right"></i></button>
                        </div>
                        <div class="relative flex-shrink-0 ml-auto">
                            <button id="exportBtn" class="btn-forge py-2 px-4 rounded-lg font-semibold text-white text-sm flex items-center gap-2">
                                <i class="fas fa-download"></i>Export<i class="fas fa-chevron-down text-xs"></i>
                            </button>
                            <div id="exportMenu" class="dropdown-menu dropdown-fixed bg-white dark:bg-night-800 rounded-lg shadow-xl border border-gray-200 dark:border-gray-700 py-1 max-h-80 overflow-y-auto" style="min-width: 220px;">
                                <div class="px-3 py-1 text-xs font-semibold text-gray-400 uppercase">Files</div>
                                <button class="w-full px-4 py-2 text-left text-sm hover:bg-gray-100 dark:hover:bg-gray-700" onclick="exportAs('xlsx')"><i class="fas fa-file-excel text-green-600 mr-2"></i>Excel (.xlsx)</button>
                                <button class="w-full px-4 py-2 text-left text-sm hover:bg-gray-100 dark:hover:bg-gray-700" onclick="exportAs('csv')"><i class="fas fa-file-csv text-emerald-600 mr-2"></i>CSV</button>
                                <button class="w-full px-4 py-2 text-left text-sm hover:bg-gray-100 dark:hover:bg-gray-700" onclick="exportAs('json')"><i class="fas fa-file-code text-blue-600 mr-2"></i>JSON</button>
                                <button class="w-full px-4 py-2 text-left text-sm hover:bg-gray-100 dark:hover:bg-gray-700" onclick="exportAs('markdown')"><i class="fas fa-file-alt text-gray-600 mr-2"></i>Markdown</button>
                                <button class="w-full px-4 py-2 text-left text-sm hover:bg-gray-100 dark:hover:bg-gray-700" onclick="exportAs('html')"><i class="fas fa-code text-orange-600 mr-2"></i>HTML Table</button>
                                <hr class="my-1 border-gray-200 dark:border-gray-700">
                                <div class="px-3 py-1 text-xs font-semibold text-gray-400 uppercase">Database</div>
                                <button class="w-full px-4 py-2 text-left text-sm hover:bg-gray-100 dark:hover:bg-gray-700" onclick="exportAs('sql-full')"><i class="fas fa-database text-purple-600 mr-2"></i>SQL (CREATE + INSERT)</button>
                                <button class="w-full px-4 py-2 text-left text-sm hover:bg-gray-100 dark:hover:bg-gray-700" onclick="exportAs('sql-insert')"><i class="fas fa-database text-purple-500 mr-2"></i>SQL (INSERT only)</button>
                                <button class="w-full px-4 py-2 text-left text-sm hover:bg-gray-100 dark:hover:bg-gray-700" onclick="exportAs('sql-postgres')"><i class="fas fa-database text-blue-700 mr-2"></i>PostgreSQL</button>
                                <button class="w-full px-4 py-2 text-left text-sm hover:bg-gray-100 dark:hover:bg-gray-700" onclick="exportAs('sql-mysql')"><i class="fas fa-database text-orange-500 mr-2"></i>MySQL</button>
                                <hr class="my-1 border-gray-200 dark:border-gray-700">
                                <div class="px-3 py-1 text-xs font-semibold text-gray-400 uppercase">Power BI / Analytics</div>
                                <button class="w-full px-4 py-2 text-left text-sm hover:bg-gray-100 dark:hover:bg-gray-700" onclick="exportAs('powerquery')"><i class="fas fa-chart-line text-yellow-500 mr-2"></i>Power Query (M Code)</button>
                                <button class="w-full px-4 py-2 text-left text-sm hover:bg-gray-100 dark:hover:bg-gray-700" onclick="exportAs('powerbi-csv')"><i class="fas fa-chart-pie text-yellow-600 mr-2"></i>Power BI CSV (UTF-8 BOM)</button>
                                <hr class="my-1 border-gray-200 dark:border-gray-700">
                                <div class="px-3 py-1 text-xs font-semibold text-gray-400 uppercase">Clipboard</div>
                                <button class="w-full px-4 py-2 text-left text-sm hover:bg-gray-100 dark:hover:bg-gray-700" onclick="copyToClip('table')"><i class="fas fa-copy text-indigo-600 mr-2"></i>Copy as TSV</button>
                                <button class="w-full px-4 py-2 text-left text-sm hover:bg-gray-100 dark:hover:bg-gray-700" onclick="copyToClip('json')"><i class="fas fa-brackets-curly text-violet-600 mr-2"></i>Copy as JSON</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Statistics Panel -->
                <div id="statsPanel" class="hidden mt-4 glass-card rounded-2xl p-4 shadow-xl fade-in">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="font-bold text-lg"><i class="fas fa-chart-bar text-forge-500 mr-2"></i>Column Statistics</h3>
                        <button onclick="document.getElementById('statsPanel').classList.add('hidden')" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
                    </div>
                    <div id="statsContent" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
                </div>
            </section>
        </div>
    </main>

    <!-- Modals -->
    <div id="modalOverlay" class="fixed inset-0 z-50 hidden modal-overlay flex items-center justify-center p-4">
        <div id="modalContent" class="bg-white dark:bg-night-800 rounded-2xl shadow-2xl max-w-lg w-full max-h-[80vh] overflow-auto"></div>
    </div>

    <!-- Chart Modal -->
    <div id="chartModal" class="fixed inset-0 z-50 hidden modal-overlay flex items-center justify-center p-4">
        <div class="bg-white dark:bg-night-800 rounded-2xl shadow-2xl max-w-2xl w-full p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="font-bold text-lg"><i class="fas fa-chart-pie text-forge-500 mr-2"></i>Quick Chart</h3>
                <button onclick="closeChartModal()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
            </div>
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium mb-1">Chart Type</label>
                    <select id="chartType" class="w-full py-2 px-3 rounded-lg bg-gray-50 dark:bg-night-900 border border-gray-200 dark:border-gray-700">
                        <option value="bar">Bar Chart</option>
                        <option value="line">Line Chart</option>
                        <option value="pie">Pie Chart</option>
                        <option value="doughnut">Doughnut</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Data Column</label>
                    <select id="chartColumn" class="w-full py-2 px-3 rounded-lg bg-gray-50 dark:bg-night-900 border border-gray-200 dark:border-gray-700"></select>
                </div>
            </div>
            <button onclick="generateChart()" class="btn-forge py-2 px-6 rounded-lg text-white font-semibold mb-4">Generate Chart</button>
            <div class="chart-container"><canvas id="chartCanvas"></canvas></div>
        </div>
    </div>

    <script>
    // ============ STATE ============
    let parsedData = [], headers = [], hiddenColumns = new Set();
    let sortColumn = null, sortDirection = 'asc', currentPage = 1, pageSize = 25, searchTerm = '';
    let selectedRows = new Set(), showRowNumbers = false, freezeFirstCol = false;
    let currentFindIndex = -1;
    let columnTypes = {}, isDarkMode = false;
    let chartInstance = null;
    let sortedIndices = null; // Store indices instead of copying data

    // ============ DOM ============
    const $ = id => document.getElementById(id);
    const inputSection = $('inputSection'), outputSection = $('outputSection');
    const tableHead = $('tableHead'), tableBody = $('tableBody');
    const searchInput = $('searchInput'), pageSizeSelect = $('pageSizeSelect');

    // ============ INIT ============
    if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.documentElement.classList.add('dark');
        isDarkMode = true;
    }
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
        document.documentElement.classList.toggle('dark', e.matches);
        isDarkMode = e.matches;
    });

    // ============ THEME TOGGLE ============
    $('themeToggle').onclick = () => {
        isDarkMode = !isDarkMode;
        document.documentElement.classList.toggle('dark', isDarkMode);
        showToast(isDarkMode ? 'Dark mode enabled' : 'Light mode enabled', 'info');
    };

    // ============ TABS ============
    ['Paste', 'Upload', 'Url'].forEach(tab => {
        $('tab' + tab).onclick = () => {
            ['Paste', 'Upload', 'Url'].forEach(t => {
                $('tab' + t).classList.toggle('bg-forge-500', t === tab);
                $('tab' + t).classList.toggle('text-white', t === tab);
                $('tab' + t).classList.toggle('shadow-lg', t === tab);
                $('tab' + t).classList.toggle('bg-gray-200', t !== tab);
                $('tab' + t).classList.toggle('dark:bg-gray-700', t !== tab);
                $(t.toLowerCase() + 'Panel').classList.toggle('hidden', t !== tab);
            });
        };
    });

    // ============ DROPDOWNS ============
    ['dataActionsBtn', 'columnActionsBtn', 'viewOptionsBtn'].forEach(btnId => {
        const btn = $(btnId);
        const menuId = btnId.replace('Btn', 'Menu');
        const menu = $(menuId);
        if (btn && menu) {
            btn.onclick = e => { e.stopPropagation(); document.querySelectorAll('.dropdown-menu').forEach(m => m !== menu && m.classList.remove('active')); menu.classList.toggle('active'); };
        }
    });

    // Export button with fixed positioning
    const exportBtn = $('exportBtn');
    const exportMenu = $('exportMenu');
    if (exportBtn && exportMenu) {
        exportBtn.onclick = e => {
            e.stopPropagation();
            document.querySelectorAll('.dropdown-menu').forEach(m => m !== exportMenu && m.classList.remove('active'));
            if (!exportMenu.classList.contains('active')) {
                const rect = exportBtn.getBoundingClientRect();
                exportMenu.style.right = (window.innerWidth - rect.right) + 'px';
                exportMenu.style.bottom = (window.innerHeight - rect.top + 8) + 'px';
                exportMenu.style.left = 'auto';
                exportMenu.style.top = 'auto';
            }
            exportMenu.classList.toggle('active');
        };
    }

    document.addEventListener('click', () => document.querySelectorAll('.dropdown-menu').forEach(m => m.classList.remove('active')));

    // ============ FILE HANDLING ============
    const MAX_ROWS = 10000; // Limit rows for memory safety
    const dropZone = $('dropZone'), fileInput = $('fileInput');
    dropZone.onclick = () => fileInput.click();
    dropZone.ondragover = e => { e.preventDefault(); dropZone.classList.add('dragover'); };
    dropZone.ondragleave = () => dropZone.classList.remove('dragover');
    dropZone.ondrop = e => { e.preventDefault(); dropZone.classList.remove('dragover'); if (e.dataTransfer.files[0]) handleFile(e.dataTransfer.files[0]); };
    fileInput.onchange = e => { if (e.target.files[0]) handleFile(e.target.files[0]); };
    $('removeFileBtn').onclick = () => { fileInput.value = ''; $('fileInfo').classList.add('hidden'); };

    function handleFile(file) {
        $('fileName').textContent = file.name;
        $('fileSize').textContent = formatSize(file.size);
        $('fileInfo').classList.remove('hidden');
        const ext = file.name.split('.').pop().toLowerCase();

        // Warning for large files
        if (file.size > 10 * 1024 * 1024) {
            showToast('Large file - limiting to ' + MAX_ROWS + ' rows', 'info');
        }

        if (ext === 'xlsx' || ext === 'xls') {
            showToast('Processing Excel file...', 'info');
            const reader = new FileReader();
            reader.onload = e => {
                try {
                    const wb = XLSX.read(new Uint8Array(e.target.result), { type: 'array', sheetRows: MAX_ROWS + 1 });
                    const sheet = wb.Sheets[wb.SheetNames[0]];
                    const data = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: '' });
                    if (data.length) {
                        headers = data[0].map((h,i) => h ? String(h) : 'Col' + (i+1));
                        parsedData = [];
                        const limit = Math.min(data.length - 1, MAX_ROWS);
                        for (let i = 1; i <= limit; i++) {
                            const r = data[i];
                            const o = {};
                            for (let j = 0; j < headers.length; j++) {
                                o[headers[j]] = r[j] !== undefined ? r[j] : '';
                            }
                            parsedData.push(o);
                        }
                        data.length = 0; // Clear source array
                        initTable();
                    }
                } catch(err) {
                    showToast('Error reading Excel file', 'error');
                }
            };
            reader.readAsArrayBuffer(file);
        } else if (ext === 'json') {
            const reader = new FileReader();
            reader.onload = e => parseJSON(e.target.result);
            reader.readAsText(file);
        } else {
            // CSV/TSV - use streaming for memory efficiency
            parsedData = [];
            headers = [];
            let rowCount = 0;
            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                step: function(row) {
                    if (rowCount === 0) {
                        headers = Object.keys(row.data);
                    }
                    if (rowCount < MAX_ROWS) {
                        parsedData.push(row.data);
                    }
                    rowCount++;
                },
                complete: function() {
                    if (rowCount > MAX_ROWS) {
                        showToast('Limited to ' + MAX_ROWS + ' of ' + rowCount + ' rows', 'info');
                    }
                    if (parsedData.length) initTable();
                    else showToast('No data found', 'error');
                },
                error: function() {
                    showToast('Error parsing file', 'error');
                }
            });
        }
    }

    function formatSize(b) { return b < 1024 ? b + ' B' : b < 1048576 ? (b/1024).toFixed(1) + ' KB' : (b/1048576).toFixed(1) + ' MB'; }

    // ============ URL IMPORT ============
    $('loadUrlBtn').onclick = async () => {
        const url = $('urlInput').value.trim();
        if (!url) return showToast('Enter a URL', 'error');
        try {
            showToast('Loading...', 'info');
            const res = await fetch(url);
            const text = await res.text();
            url.endsWith('.json') ? parseJSON(text) : parseCSV(text);
        } catch (e) { showToast('Failed to load URL', 'error'); }
    };

    // ============ PARSING ============
    $('parseBtn').onclick = () => { const t = $('dataInput').value.trim(); if (!t) return showToast('Enter data first', 'error'); t.startsWith('[') || t.startsWith('{') ? parseJSON(t) : parseCSV(t); };
    $('clearInputBtn').onclick = () => $('dataInput').value = '';

    function parseCSV(text) {
        const result = Papa.parse(text.trim(), { header: true, skipEmptyLines: true, dynamicTyping: true, preview: MAX_ROWS });
        if (result.data.length) {
            headers = result.meta.fields || Object.keys(result.data[0]);
            parsedData = result.data.slice(0, MAX_ROWS);
            if (result.data.length >= MAX_ROWS) {
                showToast('Limited to ' + MAX_ROWS + ' rows', 'info');
            }
            initTable();
        } else showToast('No data found', 'error');
    }

    function parseJSON(text) {
        try {
            let data = JSON.parse(text);
            if (!Array.isArray(data)) data = data[Object.keys(data).find(k => Array.isArray(data[k]))] || [data];
            if (data.length) {
                const limit = Math.min(data.length, MAX_ROWS);
                parsedData = [];
                const headerSet = new Set();
                for (let i = 0; i < limit; i++) {
                    const flat = flattenObj(data[i]);
                    parsedData.push(flat);
                    Object.keys(flat).forEach(k => headerSet.add(k));
                }
                headers = [...headerSet];
                if (data.length > MAX_ROWS) {
                    showToast('Limited to ' + MAX_ROWS + ' of ' + data.length + ' rows', 'info');
                }
                data = null; // Clear source
                initTable();
            }
        } catch (e) { parseCSV(text); }
    }

    function flattenObj(obj, pre = '') {
        const r = {};
        for (const k in obj) {
            const key = pre ? pre + '.' + k : k;
            if (typeof obj[k] === 'object' && obj[k] && !Array.isArray(obj[k])) Object.assign(r, flattenObj(obj[k], key));
            else r[key] = Array.isArray(obj[k]) ? JSON.stringify(obj[k]) : obj[k];
        }
        return r;
    }

    // ============ TABLE INIT ============
    function initTable() {
        sortColumn = null; sortDirection = 'asc'; currentPage = 1; searchTerm = ''; selectedRows.clear(); hiddenColumns.clear();
        searchInput.value = '';
        detectColumnTypes();
        applyFilters();
        $('rowCount').textContent = parsedData.length;
        $('colCount').textContent = headers.length;
        inputSection.classList.add('hidden');
        outputSection.classList.remove('hidden');
        updateColumnMenu();
        showToast('Loaded ' + parsedData.length + ' rows', 'success');
    }

    // ============ TYPE DETECTION ============
    function detectColumnTypes() {
        columnTypes = {};
        const sampleSize = Math.min(100, parsedData.length);
        headers.forEach(h => {
            const vals = [];
            for (let i = 0; i < sampleSize && vals.length < 50; i++) {
                const v = parsedData[i][h];
                if (v !== null && v !== undefined && v !== '') vals.push(v);
            }
            if (!vals.length) { columnTypes[h] = 'empty'; return; }
            const counts = { boolean: 0, number: 0, date: 0, string: 0 };
            vals.forEach(v => {
                if (typeof v === 'boolean') counts.boolean++;
                else if (typeof v === 'number' || (!isNaN(parseFloat(v)) && isFinite(v))) counts.number++;
                else if (/^\d{4}-\d{2}-\d{2}/.test(v) || /^\d{1,2}\/\d{1,2}\/\d{2,4}/.test(v)) counts.date++;
                else counts.string++;
            });
            columnTypes[h] = Object.entries(counts).sort((a,b) => b[1] - a[1])[0][0];
        });
    }

    // ============ FILTER & SORT ============
    // Memory-optimized: use indices instead of copying data
    function applyFilters() {
        // Build array of indices instead of copying objects
        let indices = parsedData.map((_, i) => i);

        if (searchTerm) {
            const term = searchTerm.toLowerCase();
            indices = indices.filter(i => {
                const row = parsedData[i];
                return headers.some(h => String(row[h] || '').toLowerCase().includes(term));
            });
        }

        if (sortColumn) {
            indices.sort((ai, bi) => {
                const a = parsedData[ai], b = parsedData[bi];
                let va = a[sortColumn] || '', vb = b[sortColumn] || '';
                const na = parseFloat(va), nb = parseFloat(vb);
                if (!isNaN(na) && !isNaN(nb)) return sortDirection === 'asc' ? na - nb : nb - na;
                return sortDirection === 'asc' ? String(va).localeCompare(String(vb)) : String(vb).localeCompare(String(va));
            });
        }

        sortedIndices = indices;
        renderTable();
    }

    // Helper to get filtered data length
    function getFilteredLength() { return sortedIndices ? sortedIndices.length : parsedData.length; }

    // Helper to get row at filtered index
    function getFilteredRow(idx) { return parsedData[sortedIndices ? sortedIndices[idx] : idx]; }

    // Helper to get original index from filtered index
    function getOriginalIndex(filteredIdx) { return sortedIndices ? sortedIndices[filteredIdx] : filteredIdx; }

    // ============ RENDER TABLE ============
    function renderTable() {
        const visibleHeaders = headers.filter(h => !hiddenColumns.has(h));
        let headHtml = '<tr>';
        if (showRowNumbers) headHtml += '<th class="px-2 py-2 text-center w-12">#</th>';
        headHtml += '<th class="px-2 py-2 w-10"><input type="checkbox" id="selectAll" class="w-4 h-4 rounded"></th>';
        visibleHeaders.forEach((h, i) => {
            const sorted = sortColumn === h;
            const icon = sorted ? (sortDirection === 'asc' ? 'fa-sort-up' : 'fa-sort-down') : 'fa-sort';
            const frozen = freezeFirstCol && i === 0 ? 'frozen-col bg-gradient-to-r from-forge-500 to-forge-600' : '';
            const type = columnTypes[h] || 'string';
            headHtml += '<th class="px-3 py-2 text-left whitespace-nowrap ' + frozen + '" data-col="' + esc(h) + '" draggable="true"><div class="flex items-center gap-2"><span class="type-badge type-' + type + '">' + type[0].toUpperCase() + '</span><span>' + esc(h) + '</span><i class="fas ' + icon + ' text-xs opacity-60"></i></div></th>';
        });
        headHtml += '</tr>';
        tableHead.innerHTML = headHtml;

        const total = getFilteredLength();
        const showAll = pageSize === 'all';
        const ps = showAll ? total : parseInt(pageSize);
        const pages = showAll ? 1 : Math.ceil(total / ps);
        if (currentPage > pages) currentPage = Math.max(1, pages);
        const start = showAll ? 0 : (currentPage - 1) * ps;
        const end = showAll ? total : Math.min(start + ps, total);

        let bodyHtml = '';
        for (let idx = start; idx < end; idx++) {
            const origIdx = getOriginalIndex(idx);
            const row = parsedData[origIdx];
            const sel = selectedRows.has(origIdx);
            const dupClass = row._duplicate ? 'duplicate-row' : '';
            bodyHtml += '<tr class="' + ((idx - start) % 2 ? '' : 'bg-gray-50 dark:bg-night-900/30') + ' hover:bg-forge-50 dark:hover:bg-forge-900/20 ' + (sel ? 'selected-row' : '') + ' ' + dupClass + '" data-idx="' + origIdx + '">';
            if (showRowNumbers) bodyHtml += '<td class="px-2 py-2 text-center text-gray-400 font-mono text-xs">' + (idx + 1) + '</td>';
            bodyHtml += '<td class="px-2 py-2"><input type="checkbox" class="row-select w-4 h-4 rounded" data-idx="' + origIdx + '" ' + (sel ? 'checked' : '') + '></td>';
            visibleHeaders.forEach((h, i) => {
                const frozen = freezeFirstCol && i === 0 ? 'frozen-col bg-white dark:bg-night-800' : '';
                const val = row[h] !== undefined && row[h] !== null ? row[h] : '';
                bodyHtml += '<td class="px-3 py-2 border-b border-gray-100 dark:border-gray-800 ' + frozen + '" data-col="' + esc(h) + '" data-idx="' + origIdx + '">' + esc(String(val)) + '</td>';
            });
            bodyHtml += '</tr>';
        }
        tableBody.innerHTML = bodyHtml || '<tr><td colspan="100" class="text-center py-8 text-gray-400">No data</td></tr>';

        $('pageInfo').textContent = total ? (start + 1) + '-' + end + ' of ' + total : 'No results';
        $('prevPage').disabled = currentPage <= 1;
        $('nextPage').disabled = currentPage >= pages;
        updatePageNumbers(pages);
        updateSelectedInfo();
        attachTableEvents();
    }

    function updatePageNumbers(pages) {
        const pn = $('pageNumbers');
        pn.innerHTML = '';
        const max = 5;
        let s = Math.max(1, currentPage - 2), e = Math.min(pages, s + max - 1);
        if (e - s < max - 1) s = Math.max(1, e - max + 1);
        for (let i = s; i <= e; i++) {
            const btn = document.createElement('button');
            btn.className = 'px-3 py-1 rounded text-sm ' + (i === currentPage ? 'bg-forge-500 text-white' : 'hover:bg-gray-200 dark:hover:bg-gray-700');
            btn.textContent = i;
            btn.onclick = () => { currentPage = i; renderTable(); };
            pn.appendChild(btn);
        }
    }

    function attachTableEvents() {
        const selectAll = $('selectAll');
        if (selectAll) {
            selectAll.onchange = e => {
                const checked = e.target.checked;
                const len = getFilteredLength();
                for (let i = 0; i < len; i++) {
                    const origIdx = getOriginalIndex(i);
                    checked ? selectedRows.add(origIdx) : selectedRows.delete(origIdx);
                }
                renderTable();
            };
        }

        tableBody.querySelectorAll('.row-select').forEach(cb => {
            cb.onchange = e => {
                const idx = parseInt(e.target.dataset.idx);
                e.target.checked ? selectedRows.add(idx) : selectedRows.delete(idx);
                updateSelectedInfo();
                e.target.closest('tr').classList.toggle('selected-row', e.target.checked);
            };
        });

        tableHead.querySelectorAll('th[data-col]').forEach(th => {
            th.onclick = () => {
                const col = th.dataset.col;
                if (sortColumn === col) sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
                else { sortColumn = col; sortDirection = 'asc'; }
                applyFilters();
            };
        });

        tableBody.querySelectorAll('td[data-col]').forEach(td => {
            td.ondblclick = () => {
                if (td.querySelector('input')) return;
                const col = td.dataset.col, idx = parseInt(td.dataset.idx);
                const val = parsedData[idx][col] !== undefined ? parsedData[idx][col] : '';
                const input = document.createElement('input');
                input.type = 'text'; input.className = 'cell-input dark:text-white dark:bg-night-800'; input.value = val;
                td.textContent = ''; td.appendChild(input); input.focus(); input.select();
                const save = () => { saveState(); parsedData[idx][col] = input.value; td.textContent = input.value; showToast('Updated', 'info'); };
                input.onblur = save;
                input.onkeydown = e => { if (e.key === 'Enter') input.blur(); if (e.key === 'Escape') { td.textContent = val; } };
            };
        });

        tableHead.querySelectorAll('th[draggable]').forEach(th => {
            th.ondragstart = e => { e.dataTransfer.setData('text', th.dataset.col); th.classList.add('dragging'); };
            th.ondragend = () => th.classList.remove('dragging');
            th.ondragover = e => { e.preventDefault(); th.classList.add('drag-over'); };
            th.ondragleave = () => th.classList.remove('drag-over');
            th.ondrop = e => {
                e.preventDefault(); th.classList.remove('drag-over');
                const from = e.dataTransfer.getData('text'), to = th.dataset.col;
                if (from !== to) {
                    const fi = headers.indexOf(from), ti = headers.indexOf(to);
                    headers.splice(fi, 1); headers.splice(ti, 0, from);
                    saveState(); applyFilters(); updateColumnMenu();
                }
            };
        });
    }

    function updateSelectedInfo() {
        const n = selectedRows.size;
        $('selectedInfo').classList.toggle('hidden', !n);
        $('selectedInfo').classList.toggle('flex', n > 0);
        $('selectedCount').textContent = n;
    }

    function esc(t) { const d = document.createElement('div'); d.textContent = t; return d.innerHTML; }

    // ============ COLUMN MENU ============
    function updateColumnMenu() {
        const menu = $('columnActionsMenu');
        menu.innerHTML = headers.map(h => '<div class="px-3 py-2 flex items-center justify-between hover:bg-gray-50 dark:hover:bg-gray-700"><label class="flex items-center gap-2 cursor-pointer flex-1"><input type="checkbox" class="col-vis w-4 h-4 rounded" data-col="' + esc(h) + '" ' + (hiddenColumns.has(h) ? '' : 'checked') + '><span class="text-sm truncate">' + esc(h) + '</span></label><button class="text-gray-400 hover:text-forge-500 p-1" onclick="renameColumn(\'' + esc(h).replace(/'/g, "\\'") + '\')" title="Rename"><i class="fas fa-pen text-xs"></i></button><button class="text-gray-400 hover:text-red-500 p-1" onclick="deleteColumn(\'' + esc(h).replace(/'/g, "\\'") + '\')" title="Delete"><i class="fas fa-trash text-xs"></i></button></div>').join('');
        menu.querySelectorAll('.col-vis').forEach(cb => {
            cb.onchange = e => {
                const col = e.target.dataset.col;
                e.target.checked ? hiddenColumns.delete(col) : hiddenColumns.add(col);
                renderTable();
            };
        });
    }

    // ============ ROW OPERATIONS ============
    function addRow() { saveState(); const newRow = {}; headers.forEach(h => newRow[h] = ''); parsedData.unshift(newRow); applyFilters(); $('rowCount').textContent = parsedData.length; showToast('Row added', 'success'); }

    function deleteSelectedRows() {
        if (!selectedRows.size) return showToast('Select rows first', 'error');
                const indices = [...selectedRows].sort((a,b) => b - a);
        indices.forEach(i => parsedData.splice(i, 1));
        selectedRows.clear();
        applyFilters();
        $('rowCount').textContent = parsedData.length;
        showToast('Deleted ' + indices.length + ' rows', 'success');
    }

    // ============ COLUMN OPERATIONS ============
    function showAddColumnModal() {
        showModal('Add Column', '<div class="space-y-4"><div><label class="block text-sm font-medium mb-1">Column Name</label><input type="text" id="newColName" class="w-full py-2 px-3 rounded-lg bg-gray-50 dark:bg-night-900 border border-gray-200 dark:border-gray-700"></div><div><label class="block text-sm font-medium mb-1">Default Value</label><input type="text" id="newColDefault" class="w-full py-2 px-3 rounded-lg bg-gray-50 dark:bg-night-900 border border-gray-200 dark:border-gray-700"></div><button onclick="addColumn()" class="btn-forge py-2 px-6 rounded-lg text-white font-semibold">Add Column</button></div>');
    }

    function addColumn() {
        const name = $('newColName').value.trim();
        if (!name) return showToast('Enter column name', 'error');
        if (headers.includes(name)) return showToast('Column exists', 'error');
                const def = $('newColDefault').value;
        headers.push(name);
        parsedData.forEach(r => r[name] = def);
        detectColumnTypes();
        applyFilters();
        updateColumnMenu();
        closeModal();
        showToast('Column added', 'success');
    }

    function deleteColumn(col) {
        showConfirm('Delete column "' + col + '"?', () => {
                        headers = headers.filter(h => h !== col);
            parsedData.forEach(r => delete r[col]);
            hiddenColumns.delete(col);
            detectColumnTypes();
            applyFilters();
            updateColumnMenu();
            $('colCount').textContent = headers.length;
            showToast('Column deleted', 'success');
        });
    }

    function renameColumn(col) {
        showModal('Rename Column', '<div class="space-y-4"><div><label class="block text-sm font-medium mb-1">New Name</label><input type="text" id="renameColInput" value="' + esc(col) + '" class="w-full py-2 px-3 rounded-lg bg-gray-50 dark:bg-night-900 border border-gray-200 dark:border-gray-700"></div><button onclick="doRenameColumn(\'' + esc(col).replace(/'/g, "\\'") + '\')" class="btn-forge py-2 px-6 rounded-lg text-white font-semibold">Rename</button></div>');
    }

    function doRenameColumn(oldName) {
        const newName = $('renameColInput').value.trim();
        if (!newName || newName === oldName) return closeModal();
        if (headers.includes(newName)) return showToast('Name exists', 'error');
                const idx = headers.indexOf(oldName);
        headers[idx] = newName;
        parsedData.forEach(r => { r[newName] = r[oldName]; delete r[oldName]; });
        if (hiddenColumns.has(oldName)) { hiddenColumns.delete(oldName); hiddenColumns.add(newName); }
        if (sortColumn === oldName) sortColumn = newName;
        detectColumnTypes();
        applyFilters();
        updateColumnMenu();
        closeModal();
        showToast('Column renamed', 'success');
    }

    function showFormulaModal() {
        showModal('Formula Column', '<div class="space-y-4"><div><label class="block text-sm font-medium mb-1">New Column Name</label><input type="text" id="formulaColName" class="w-full py-2 px-3 rounded-lg bg-gray-50 dark:bg-night-900 border border-gray-200 dark:border-gray-700"></div><div><label class="block text-sm font-medium mb-1">Formula</label><textarea id="formulaInput" rows="3" class="w-full py-2 px-3 rounded-lg bg-gray-50 dark:bg-night-900 border border-gray-200 dark:border-gray-700 font-mono text-sm" placeholder="row[\'col1\'] + row[\'col2\']"></textarea><p class="text-xs text-gray-500 mt-1">Use row[\'columnName\'] to access values. JS expressions allowed.</p></div><button onclick="applyFormula()" class="btn-forge py-2 px-6 rounded-lg text-white font-semibold">Create Column</button></div>');
    }

    function applyFormula() {
        const name = $('formulaColName').value.trim();
        const formula = $('formulaInput').value.trim();
        if (!name || !formula) return showToast('Fill all fields', 'error');
        if (headers.includes(name)) return showToast('Column exists', 'error');
        try {
                        const fn = new Function('row', 'return ' + formula);
            headers.push(name);
            parsedData.forEach(r => { try { r[name] = fn(r); } catch (e) { r[name] = 'ERROR'; } });
            detectColumnTypes();
            applyFilters();
            updateColumnMenu();
            closeModal();
            showToast('Formula column created', 'success');
        } catch (e) { showToast('Invalid formula', 'error'); }
    }

    // ============ FIND & REPLACE ============
    function toggleFindReplace() { $('findReplacePanel').classList.toggle('hidden'); }

    function findNext() {
        const term = $('findInput').value;
        if (!term) return;
        // Count matches without storing them (memory efficient)
        let count = 0;
        const termLower = term.toLowerCase();
        for (let ri = 0; ri < parsedData.length; ri++) {
            const row = parsedData[ri];
            for (let hi = 0; hi < headers.length; hi++) {
                if (String(row[headers[hi]] || '').toLowerCase().includes(termLower)) count++;
            }
        }
        $('findCount').textContent = count + ' matches';
        // Find next match starting from currentFindIndex
        let found = 0;
        for (let ri = 0; ri < parsedData.length; ri++) {
            const row = parsedData[ri];
            for (let hi = 0; hi < headers.length; hi++) {
                if (String(row[headers[hi]] || '').toLowerCase().includes(termLower)) {
                    if (found > currentFindIndex) {
                        currentFindIndex = found;
                        highlightMatch(ri, headers[hi]);
                        return;
                    }
                    found++;
                }
            }
        }
        // Wrap around
        currentFindIndex = -1;
        if (count > 0) findNext();
    }

    function highlightMatch(rowIdx, col) {
        let pageIdx = -1;
        const len = getFilteredLength();
        for (let i = 0; i < len; i++) {
            if (getOriginalIndex(i) === rowIdx) { pageIdx = i; break; }
        }
        if (pageIdx >= 0) {
            const ps = pageSize === 'all' ? len : parseInt(pageSize);
            currentPage = Math.floor(pageIdx / ps) + 1;
            renderTable();
            setTimeout(() => {
                const td = tableBody.querySelector('td[data-idx="' + rowIdx + '"][data-col="' + col + '"]');
                if (td) { td.scrollIntoView({ block: 'center' }); td.classList.add('bg-yellow-200', 'dark:bg-yellow-800'); }
            }, 50);
        }
    }

    function replaceOne() {
        const find = $('findInput').value, replace = $('replaceInput').value;
        if (!find) return;
        const termLower = find.toLowerCase();
        for (let ri = 0; ri < parsedData.length; ri++) {
            const row = parsedData[ri];
            for (let hi = 0; hi < headers.length; hi++) {
                const h = headers[hi];
                if (String(row[h] || '').toLowerCase().includes(termLower)) {
                    row[h] = String(row[h]).replace(new RegExp(find, 'gi'), replace);
                    applyFilters();
                    showToast('Replaced 1 occurrence', 'success');
                    return;
                }
            }
        }
    }

    function replaceAll() {
        const find = $('findInput').value, replace = $('replaceInput').value;
        if (!find) return;
        let count = 0;
        const termLower = find.toLowerCase();
        for (let ri = 0; ri < parsedData.length; ri++) {
            const row = parsedData[ri];
            for (let hi = 0; hi < headers.length; hi++) {
                const h = headers[hi];
                const val = String(row[h] || '');
                if (val.toLowerCase().includes(termLower)) {
                    row[h] = val.replace(new RegExp(find, 'gi'), replace);
                    count++;
                }
            }
        }
        applyFilters();
        showToast('Replaced ' + count + ' occurrences', 'success');
    }

    // ============ DUPLICATES & CLEANING ============
    function findDuplicates() {
        // Clear previous duplicate markers first
        parsedData.forEach(row => delete row._duplicate);

        const seen = new Map();
        let count = 0;
        for (let i = 0; i < parsedData.length; i++) {
            const row = parsedData[i];
            // Create hash key more efficiently
            let key = '';
            for (let j = 0; j < headers.length; j++) {
                key += String(row[headers[j]] || '') + '|';
            }
            if (seen.has(key)) {
                row._duplicate = true;
                parsedData[seen.get(key)]._duplicate = true;
                count++;
            } else {
                seen.set(key, i);
            }
        }
        applyFilters();
        showToast('Found ' + count + ' duplicate rows', count ? 'info' : 'success');
    }

    function cleanData() {
                let cleaned = 0;
        parsedData.forEach(row => {
            headers.forEach(h => {
                if (typeof row[h] === 'string') {
                    const orig = row[h];
                    row[h] = row[h].trim().replace(/\s+/g, ' ');
                    if (row[h] !== orig) cleaned++;
                }
            });
            delete row._duplicate;
        });
        applyFilters();
        showToast('Cleaned ' + cleaned + ' cells', 'success');
    }

    // ============ MERGE FILE ============
    function mergeFile() {
        showModal('Merge File', '<div class="space-y-4"><p class="text-sm text-gray-600 dark:text-gray-400">Upload a file to merge with current data.</p><input type="file" id="mergeFileInput" accept=".csv,.json,.xlsx" class="w-full"><button onclick="doMergeFile()" class="btn-forge py-2 px-6 rounded-lg text-white font-semibold mt-3">Merge</button></div>');
    }

    function doMergeFile() {
        const file = $('mergeFileInput') ? $('mergeFileInput').files[0] : null;
        if (!file) return showToast('Select a file', 'error');
        const remaining = MAX_ROWS - parsedData.length;
        if (remaining <= 0) return showToast('Already at max rows (' + MAX_ROWS + ')', 'error');
        const ext = file.name.split('.').pop().toLowerCase();
        const reader = new FileReader();
        reader.onload = e => {
            let newData = [];
            if (ext === 'json') {
                newData = JSON.parse(e.target.result);
                if (!Array.isArray(newData)) newData = [newData];
            } else if (ext === 'xlsx') {
                const wb = XLSX.read(new Uint8Array(e.target.result), { type: 'array', sheetRows: remaining + 1 });
                const data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { header: 1 });
                const h = data[0];
                for (let i = 1; i < Math.min(data.length, remaining + 1); i++) {
                    const o = {};
                    h.forEach((hh, j) => o[hh] = data[i][j]);
                    newData.push(o);
                }
            } else {
                const result = Papa.parse(e.target.result, { header: true, skipEmptyLines: true, preview: remaining });
                newData = result.data;
            }
            newData = newData.slice(0, remaining);
            if (newData.length) {
                const headerSet = new Set(headers);
                newData.forEach(row => Object.keys(row).forEach(k => headerSet.add(k)));
                headers = [...headerSet];
                parsedData = parsedData.concat(newData);
                detectColumnTypes();
                applyFilters();
                updateColumnMenu();
                closeModal();
                showToast('Merged ' + newData.length + ' rows', 'success');
            }
        };
        ext === 'xlsx' ? reader.readAsArrayBuffer(file) : reader.readAsText(file);
    }

    // ============ STATISTICS ============
    function showStatsPanel() {
        const panel = $('statsPanel');
        panel.classList.remove('hidden');
        const content = $('statsContent');
        content.innerHTML = headers.map(h => {
            const type = columnTypes[h];
            let count = 0, sum = 0, min = Infinity, max = -Infinity, numCount = 0;
            const uniqueSet = new Set();

            // Single pass through data for efficiency
            for (let i = 0; i < parsedData.length; i++) {
                const v = parsedData[i][h];
                if (v === null || v === undefined || v === '') continue;
                count++;
                if (type !== 'number') {
                    uniqueSet.add(v);
                } else {
                    const num = Number(v);
                    if (!isNaN(num)) {
                        sum += num;
                        if (num < min) min = num;
                        if (num > max) max = num;
                        numCount++;
                    }
                }
            }

            let stats = '<div class="text-xs text-gray-500">Total: ' + count + '</div>';
            if (type === 'number' && numCount > 0) {
                const avg = sum / numCount;
                stats += '<div class="grid grid-cols-2 gap-1 text-xs mt-2"><div>Min: <span class="font-mono">' + min.toFixed(2) + '</span></div><div>Max: <span class="font-mono">' + max.toFixed(2) + '</span></div><div>Sum: <span class="font-mono">' + sum.toFixed(2) + '</span></div><div>Avg: <span class="font-mono">' + avg.toFixed(2) + '</span></div></div>';
            } else {
                stats += '<div class="text-xs mt-2">Unique: <span class="font-mono">' + uniqueSet.size + '</span></div>';
            }
            return '<div class="p-3 rounded-lg bg-gray-50 dark:bg-night-900/50 border border-gray-200 dark:border-gray-700"><div class="font-semibold text-sm mb-1 flex items-center gap-2"><span class="type-badge type-' + type + '">' + type[0].toUpperCase() + '</span>' + esc(h) + '</div>' + stats + '</div>';
        }).join('');
    }

    // ============ CHARTS ============
    function showChartModal() {
        $('chartModal').classList.remove('hidden');
        const sel = $('chartColumn');
        sel.innerHTML = headers.map(h => '<option value="' + esc(h) + '">' + esc(h) + '</option>').join('');
    }

    function closeChartModal() { $('chartModal').classList.add('hidden'); if (chartInstance) { chartInstance.destroy(); chartInstance = null; } }

    function generateChart() {
        const col = $('chartColumn').value;
        const type = $('chartType').value;

        // Process data more efficiently - single pass
        const counts = {};
        let numericVals = [];
        let isNumeric = true;

        for (let i = 0; i < parsedData.length && (numericVals.length < 1000 || Object.keys(counts).length < 100); i++) {
            const v = parsedData[i][col];
            if (v === null || v === undefined || v === '') continue;
            const num = Number(v);
            if (!isNaN(num)) {
                numericVals.push(num);
            } else {
                isNumeric = false;
            }
            counts[v] = (counts[v] || 0) + 1;
        }

        let labels, data;
        if (isNumeric && numericVals.length) {
            labels = numericVals.slice(0, 20).map((_, i) => i + 1);
            data = numericVals.slice(0, 20);
        } else {
            const sorted = Object.entries(counts).sort((a, b) => b[1] - a[1]).slice(0, 10);
            labels = sorted.map(e => e[0]);
            data = sorted.map(e => e[1]);
        }
        if (chartInstance) chartInstance.destroy();
        chartInstance = new Chart($('chartCanvas'), {
            type: type,
            data: {
                labels: labels,
                datasets: [{ label: col, data: data, backgroundColor: ['#f2a628', '#cf6509', '#eb8a0f', '#f5be4f', '#ac460b', '#8c3710', '#732e10', '#fcecc8', '#f9d88c', '#fef7ec'] }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: type === 'pie' || type === 'doughnut' } } }
        });
    }

    // ============ VIEW OPTIONS ============
    function toggleRowNumbers() { showRowNumbers = !showRowNumbers; $('rowNumLabel').textContent = showRowNumbers ? 'Hide Row Numbers' : 'Show Row Numbers'; renderTable(); }
    function toggleFreezeFirstCol() { freezeFirstCol = !freezeFirstCol; $('freezeLabel').textContent = freezeFirstCol ? 'Unfreeze First Column' : 'Freeze First Column'; renderTable(); }
    function toggleFullscreen() { const el = $('tableWrapper'); if (!document.fullscreenElement) el.requestFullscreen && el.requestFullscreen(); else document.exitFullscreen && document.exitFullscreen(); }

    // ============ EXPORT ============
    function getExportData() {
        // Get filtered data as array without copying the entire dataset
        const len = getFilteredLength();
        if (len === parsedData.length && !sortedIndices) return parsedData;
        const result = [];
        for (let i = 0; i < len; i++) result.push(parsedData[getOriginalIndex(i)]);
        return result;
    }

    function getSqlType(colName) {
        const type = columnTypes[colName] || 'string';
        if (type === 'number') return 'NUMERIC';
        if (type === 'boolean') return 'BOOLEAN';
        if (type === 'date') return 'DATE';
        return 'VARCHAR(255)';
    }

    function sqlEscape(val, dialect) {
        if (val === undefined || val === null || val === '') return 'NULL';
        if (typeof val === 'number') return val;
        if (typeof val === 'boolean') return val ? 'TRUE' : 'FALSE';
        const escaped = String(val).replace(/'/g, "''");
        return "'" + escaped + "'";
    }

    function exportAs(format) {
        const data = getExportData();
        const visHeaders = headers.filter(h => !hiddenColumns.has(h));
        const tableName = 'data_table';
        let content, filename, mime;

        switch (format) {
            case 'xlsx':
                const ws = XLSX.utils.json_to_sheet(data.map(r => { const o = {}; visHeaders.forEach(h => o[h] = r[h]); return o; }));
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Data');
                XLSX.writeFile(wb, 'data_export.xlsx');
                return showToast('Excel exported', 'success');

            case 'csv':
                content = Papa.unparse(data, { columns: visHeaders });
                filename = 'data_export.csv'; mime = 'text/csv';
                break;

            case 'json':
                content = JSON.stringify(data.map(r => { const o = {}; visHeaders.forEach(h => o[h] = r[h]); return o; }), null, 2);
                filename = 'data_export.json'; mime = 'application/json';
                break;

            case 'markdown':
                content = '| ' + visHeaders.join(' | ') + ' |\n| ' + visHeaders.map(() => '---').join(' | ') + ' |\n';
                content += data.map(r => '| ' + visHeaders.map(h => r[h] !== undefined ? r[h] : '').join(' | ') + ' |').join('\n');
                filename = 'data_export.md'; mime = 'text/markdown';
                break;

            case 'html':
                content = '<table border="1">\n<thead><tr>' + visHeaders.map(h => '<th>' + esc(h) + '</th>').join('') + '</tr></thead>\n<tbody>' + data.map(r => '<tr>' + visHeaders.map(h => '<td>' + esc(String(r[h] !== undefined ? r[h] : '')) + '</td>').join('') + '</tr>').join('\n') + '</tbody>\n</table>';
                filename = 'data_export.html'; mime = 'text/html';
                break;

            // === DATABASE EXPORTS ===
            case 'sql-insert':
                const cols1 = visHeaders.map(h => '`' + h + '`').join(', ');
                const rows1 = data.map(r => '(' + visHeaders.map(h => sqlEscape(r[h])).join(', ') + ')');
                content = '-- SQL INSERT Statements\n';
                content += 'INSERT INTO `' + tableName + '` (' + cols1 + ') VALUES\n' + rows1.join(',\n') + ';';
                filename = 'data_export.sql'; mime = 'text/plain';
                break;

            case 'sql-full':
                content = '-- SQL CREATE TABLE + INSERT\n';
                content += 'CREATE TABLE `' + tableName + '` (\n';
                content += visHeaders.map(h => '  `' + h + '` ' + getSqlType(h)).join(',\n');
                content += '\n);\n\n';
                const cols2 = visHeaders.map(h => '`' + h + '`').join(', ');
                const rows2 = data.map(r => '(' + visHeaders.map(h => sqlEscape(r[h])).join(', ') + ')');
                content += 'INSERT INTO `' + tableName + '` (' + cols2 + ') VALUES\n' + rows2.join(',\n') + ';';
                filename = 'data_export.sql'; mime = 'text/plain';
                break;

            case 'sql-postgres':
                content = '-- PostgreSQL Export\n';
                content += 'CREATE TABLE IF NOT EXISTS "' + tableName + '" (\n';
                content += visHeaders.map(h => '  "' + h + '" ' + getSqlType(h).replace('VARCHAR(255)', 'TEXT')).join(',\n');
                content += '\n);\n\n';
                const colsPg = visHeaders.map(h => '"' + h + '"').join(', ');
                const rowsPg = data.map(r => '(' + visHeaders.map(h => sqlEscape(r[h])).join(', ') + ')');
                content += 'INSERT INTO "' + tableName + '" (' + colsPg + ') VALUES\n' + rowsPg.join(',\n') + ';';
                filename = 'data_export_postgres.sql'; mime = 'text/plain';
                break;

            case 'sql-mysql':
                content = '-- MySQL Export\n';
                content += 'CREATE TABLE IF NOT EXISTS `' + tableName + '` (\n';
                content += visHeaders.map(h => '  `' + h + '` ' + getSqlType(h)).join(',\n');
                content += '\n) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;\n\n';
                const colsMy = visHeaders.map(h => '`' + h + '`').join(', ');
                const rowsMy = data.map(r => '(' + visHeaders.map(h => sqlEscape(r[h])).join(', ') + ')');
                content += 'INSERT INTO `' + tableName + '` (' + colsMy + ') VALUES\n' + rowsMy.join(',\n') + ';';
                filename = 'data_export_mysql.sql'; mime = 'text/plain';
                break;

            // === POWER BI EXPORTS ===
            case 'powerquery':
                content = '// Power Query M Code - Paste in Power BI Advanced Editor\n';
                content += 'let\n';
                content += '    Source = #table(\n';
                content += '        type table [' + visHeaders.map(h => '#"' + h + '" = ' + (columnTypes[h] === 'number' ? 'number' : 'text')).join(', ') + '],\n';
                content += '        {\n';
                const mRows = data.slice(0, 1000).map(r => {
                    return '            {' + visHeaders.map(h => {
                        const v = r[h];
                        if (v === undefined || v === null || v === '') return 'null';
                        if (typeof v === 'number') return v;
                        return '"' + String(v).replace(/"/g, '""') + '"';
                    }).join(', ') + '}';
                });
                content += mRows.join(',\n');
                content += '\n        }\n';
                content += '    )\n';
                content += 'in\n';
                content += '    Source';
                if (data.length > 1000) content += '\n\n// Note: Limited to 1000 rows. For larger datasets, use CSV import.';
                filename = 'data_export_powerquery.pq'; mime = 'text/plain';
                break;

            case 'powerbi-csv':
                // UTF-8 BOM for Excel/Power BI compatibility
                const bom = '\uFEFF';
                content = bom + Papa.unparse(data, { columns: visHeaders });
                filename = 'data_export_powerbi.csv'; mime = 'text/csv;charset=utf-8';
                break;

            default:
                showToast('Unknown format', 'error');
                return;
        }
        downloadFile(content, filename, mime);
        showToast(format.toUpperCase() + ' exported', 'success');
    }

    function copyToClip(type) {
        const data = getExportData();
        const visHeaders = headers.filter(h => !hiddenColumns.has(h));
        let content;
        if (type === 'json') content = JSON.stringify(data.map(r => { const o = {}; visHeaders.forEach(h => o[h] = r[h]); return o; }), null, 2);
        else content = [visHeaders.join('\t')].concat(data.map(r => visHeaders.map(h => r[h] !== undefined ? r[h] : '').join('\t'))).join('\n');
        navigator.clipboard && navigator.clipboard.writeText(content).then(() => showToast('Copied!', 'success'));
    }

    function downloadFile(content, filename, mime) {
        const blob = new Blob([content], { type: mime });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = filename;
        a.click();
        URL.revokeObjectURL(a.href);
    }

    // ============ KEYBOARD SHORTCUTS ============
    document.addEventListener('keydown', e => {
        if ((e.ctrlKey || e.metaKey) && e.key === 'f' && !outputSection.classList.contains('hidden')) { e.preventDefault(); toggleFindReplace(); $('findInput').focus(); }
        if (e.key === 'Escape') { closeModal(); closeChartModal(); $('findReplacePanel').classList.add('hidden'); }
        if (!outputSection.classList.contains('hidden') && ['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'].includes(e.key)) {
            const active = document.activeElement;
            if (active && active.tagName === 'TD') {
                e.preventDefault();
                const cells = Array.from(tableBody.querySelectorAll('td[data-col]'));
                const idx = cells.indexOf(active);
                const cols = headers.filter(h => !hiddenColumns.has(h)).length;
                let newIdx = idx;
                if (e.key === 'ArrowRight') newIdx = Math.min(idx + 1, cells.length - 1);
                if (e.key === 'ArrowLeft') newIdx = Math.max(idx - 1, 0);
                if (e.key === 'ArrowDown') newIdx = Math.min(idx + cols, cells.length - 1);
                if (e.key === 'ArrowUp') newIdx = Math.max(idx - cols, 0);
                if (cells[newIdx]) { cells[newIdx].setAttribute('tabindex', '0'); cells[newIdx].focus(); }
            }
        }
    });

    tableBody.addEventListener('click', e => { if (e.target.tagName === 'TD') { e.target.setAttribute('tabindex', '0'); e.target.focus(); } });

    // ============ MODALS ============
    function showModal(title, content) {
        $('modalContent').innerHTML = '<div class="p-6"><div class="flex items-center justify-between mb-4"><h3 class="font-bold text-lg">' + title + '</h3><button onclick="closeModal()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button></div>' + content + '</div>';
        $('modalOverlay').classList.remove('hidden');
    }

    function closeModal() { $('modalOverlay').classList.add('hidden'); }

    function showConfirm(msg, onConfirm) {
        showModal('Confirm', '<p class="mb-4">' + msg + '</p><div class="flex gap-3"><button onclick="closeModal()" class="flex-1 py-2 rounded-lg bg-gray-200 dark:bg-gray-700">Cancel</button><button id="confirmBtn" class="flex-1 py-2 rounded-lg bg-red-500 text-white">Confirm</button></div>');
        $('confirmBtn').onclick = () => { closeModal(); onConfirm(); };
    }

    $('modalOverlay').onclick = e => { if (e.target === $('modalOverlay')) closeModal(); };

    // ============ TOAST ============
    function showToast(msg, type) {
        type = type || 'success';
        const toast = document.createElement('div');
        const bg = type === 'success' ? 'bg-emerald-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500';
        const icon = type === 'success' ? 'fa-check' : type === 'error' ? 'fa-xmark' : 'fa-info';
        toast.className = 'toast ' + bg + ' text-white px-4 py-3 rounded-xl shadow-lg flex items-center gap-3';
        toast.innerHTML = '<i class="fas ' + icon + '"></i><span>' + msg + '</span>';
        $('toastContainer').appendChild(toast);
        setTimeout(() => { toast.style.opacity = '0'; toast.style.transform = 'translateX(100%)'; toast.style.transition = 'all 0.3s'; setTimeout(() => toast.remove(), 300); }, 2500);
    }

    // ============ PAGINATION & SEARCH ============
    searchInput.oninput = e => { searchTerm = e.target.value; currentPage = 1; applyFilters(); };
    pageSizeSelect.onchange = e => { pageSize = e.target.value === 'all' ? 'all' : parseInt(e.target.value); currentPage = 1; renderTable(); };
    $('prevPage').onclick = () => { if (currentPage > 1) { currentPage--; renderTable(); } };
    $('nextPage').onclick = () => { currentPage++; renderTable(); };
    $('backBtn').onclick = () => { outputSection.classList.add('hidden'); inputSection.classList.remove('hidden'); };
    </script>



</body></html>